# 詢問Vespa
Vespa搜尋引擎搜尋流程圖官方唯一指定推薦圖，如下：
![](https://docs.vespa.ai/documentation/img/query-to-response.svg)

## 搜尋流程
一個搜尋指令進入Vespa，會經過兩個主流程：
1. 搜尋階段
2. 結果預處理階段

> 更正確來說，並不是搜尋只需要這兩個流程，而是兩個對於內容叢集(content cluster)存取的發動充分條件。

### 搜尋階段
1. REST API進入Vespa後會先被切割成Vespa內部預設的API型態
2. `Query Pre-Processing`包括語言處理及詢問重組是利用設定好的搜尋鍊(Search Chain)完成
3. 搜尋鍊完成的重組詢問邏輯會傳遞到各自選定的內容叢集
4. 請設定內容叢集分配邏輯
5. 在內容叢集中執行**匹配**/**排序**/**重組**/**分群**行為。
6. Vespa的內容叢集在timeout時間內完成對應的行為後，會回傳結果到容器層。初期回應的資料只包含精煉結果像覆蓋度及總個數。剩餘的內容要在結果預處理結束後才去拿。

> 不知道是哪個天才設計這種機制...所以實際Vespa打query每次看到結果都很享受(偶爾timeout，偶爾結果A，偶爾結果B，真的是百花齊放百家爭鳴...)

### 結果預處理階段
- 搜尋階段完成的結果就會開始進行預處理，這裡的搜尋重組就是所謂的後搜尋器。
- 文件結論在本階段完成。
- 收尾工作也在這喔。

## 結論
1. 搜尋器(Searcher)就是存在於容器層內部的YQL等效產生器。
2. 渲染器不算進階段中。
3. Vespa所謂的兩階段式搜尋指的就是**搜尋階段**與**結果預處理階段**。

## 參考資料
- [原文](https://docs.vespa.ai/documentation/querying-vespa.html)
